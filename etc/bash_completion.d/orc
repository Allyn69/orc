# Provides bash completion for the orc command
# Currently supports completing all long options, environment and application.
#
# Potential improvements:
#   * the set of options should be generated by orc code, so it remains in sync when new options are added
#   * once --environment has been specified, filter applications to only those in that environment, and vice-versa
#   * behave more nicely

_orc()
{
  CMDB_HOME=$HOME/.cmdb

  local cur=${COMP_WORDS[COMP_CWORD]}
  local prev=${COMP_WORDS[COMP_CWORD-1]}

  case "$prev" in
    -e|--environment)
      local all_environments="$(test -d $CMDB_HOME && ls -1 $CMDB_HOME)"
      COMPREPLY=( $(compgen -W "${all_environments}" -- "$cur" ))
      return 0
      ;;
    -a|--application)
      local all_applications="$(test -d $CMDB_HOME && find $CMDB_HOME -name "*.yaml" -type f -exec basename {} ';' | sed -e 's/.yaml//g' | sort | uniq )"
      COMPREPLY=( $(compgen -W "${all_applications}" -- "$cur" ))
      return 0
      ;;
  esac

  COMPREPLY=( $(compgen -W "--debug --clean-instances --environment --promote-from --application\
                            --version --group --status --deploy --install \
                            --limited-install --swap --resolve --promote" -- "$cur") )

}
complete -F _orc orc
